name: DevSecOps Pipeline

# Trigger on push to main branch
on:
  push:
    branches: [ "main" ]

jobs:
  security-scan-build-deploy:
    runs-on: self-hosted  # your runner
    steps:
      # 1️⃣ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Scan Dockerfile / project with Trivy
      - name: Security scan with Trivy
        run: |
          docker pull alpine:latest
          trivy fs --severity CRITICAL --exit-code 1 .

      # 3️⃣ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t secure-app:latest .

      # 4️⃣ Push image (optional if you have a registry)
      #- name: Push image to registry
      #  run: |
      #    docker tag secure-app:latest <YOUR_REGISTRY>/secure-app:latest
      #    docker push <YOUR_REGISTRY>/secure-app:latest

      # 5️⃣ Deploy to Kubernetes
      - name: Deploy to K8s
        run: |
          kubectl apply -f deployment.yaml
